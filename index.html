<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="2.1.7">
    <meta name="description" content="ef-sin Inventur v2.1.7 - Button Event-Listener Fix">
    <title>ef-sin Inventur v2.1.7</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dark-mode.css">
    <link rel="stylesheet" href="icon-picker.css">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    
    <style>
    /* ========================================
       MODAL FIX - HEADER & FOOTER IMMER SICHTBAR
       ======================================== */
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background: var(--modal-bg, #ffffff);
        border-radius: 12px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        margin: auto;
    }
    
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color, #dee2e6);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 20px;
    }
    
    .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }
    
    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid var(--border-color, #dee2e6);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-shrink: 0;
    }
    
    @media (max-width: 600px) {
        .modal {
            padding: 10px;
        }
        
        .modal-content {
            max-height: 95vh;
            border-radius: 8px;
        }
        
        .modal-header {
            padding: 15px;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        .modal-footer {
            padding: 12px 15px;
            flex-direction: column;
        }
        
        .modal-footer button {
            width: 100%;
        }
    }
    
    /* ========================================
       DASHBOARD & STATISTICS STYLING
       ======================================== */
    
    /* Main Tabs Navigation */
    .main-tabs {
        display: flex;
        background: var(--surface, #242424);
        border-bottom: 2px solid var(--primary, #ff6b00);
        overflow-x: auto;
        scrollbar-width: none;
    }
    
    .main-tabs::-webkit-scrollbar {
        display: none;
    }
    
    .main-tab {
        flex: 1;
        min-width: 80px;
        padding: 15px 10px;
        background: transparent;
        border: none;
        color: var(--text-secondary, #999);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        text-align: center;
    }
    
    .main-tab.active {
        color: var(--primary, #ff6b00);
        border-bottom-color: var(--primary, #ff6b00);
    }
    
    .main-tab:hover {
        background: var(--surface-elevated, #2a2a2a);
    }
    
    /* Tab Content */
    .tab-content {
        display: none;
        padding: 20px;
        animation: fadeIn 0.3s;
    }
    
    .tab-content.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Dashboard Cards */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .dashboard-card {
        background: var(--surface, #242424);
        border: 1px solid var(--border-color, #333);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 0, 0.2);
    }
    
    .dashboard-card-icon {
        font-size: 48px;
        margin-bottom: 10px;
    }
    
    .dashboard-card-value {
        font-size: 32px;
        font-weight: bold;
        color: var(--primary, #ff6b00);
        margin-bottom: 5px;
    }
    
    .dashboard-card-label {
        font-size: 14px;
        color: var(--text-secondary, #999);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .dashboard-card.warning {
        border-color: #ff6b00;
        background: rgba(255, 107, 0, 0.1);
    }
    
    .dashboard-card.warning .dashboard-card-value {
        color: #ff6b00;
    }
    
    /* Statistics Section */
    .stats-section {
        margin-bottom: 30px;
    }
    
    .stats-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary, #e0e0e0);
        margin-bottom: 15px;
        padding-left: 10px;
        border-left: 4px solid var(--primary, #ff6b00);
    }
    
    /* Category Chart */
    .category-chart {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .chart-bar {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chart-icon {
        font-size: 24px;
        width: 32px;
        text-align: center;
    }
    
    .chart-label {
        width: 100px;
        font-size: 14px;
        color: var(--text-primary, #e0e0e0);
    }
    
    .chart-bar-container {
        flex: 1;
        height: 30px;
        background: var(--surface, #242424);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }
    
    .chart-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary, #ff6b00), #ff8533);
        border-radius: 15px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
        color: white;
        font-size: 12px;
        font-weight: 600;
    }
    
    /* Value Distribution */
    .value-distribution {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
    }
    
    .value-item {
        background: var(--surface, #242424);
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid var(--primary, #ff6b00);
    }
    
    .value-item-name {
        font-size: 12px;
        color: var(--text-secondary, #999);
        margin-bottom: 5px;
    }
    
    .value-item-value {
        font-size: 20px;
        font-weight: bold;
        color: var(--primary, #ff6b00);
    }
    
    /* Recent Activity */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .activity-item {
        background: var(--surface, #242424);
        padding: 12px;
        border-radius: 8px;
        border-left: 3px solid var(--primary, #ff6b00);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .activity-info {
        flex: 1;
    }
    
    .activity-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary, #e0e0e0);
    }
    
    .activity-details {
        font-size: 12px;
        color: var(--text-secondary, #999);
        margin-top: 3px;
    }
    
    .activity-stock {
        font-size: 18px;
        font-weight: bold;
        color: var(--primary, #ff6b00);
    }
    
    /* Kategorie-Liste Styling */
    .category-list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        margin-bottom: 10px;
        background: var(--surface, #242424);
        border-radius: 8px;
        border: 1px solid var(--border-color, #333);
    }
    
    .category-list-item-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }
    
    .category-list-item-icon {
        font-size: 28px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--surface-elevated, #2a2a2a);
        border-radius: 8px;
    }
    
    .category-list-item-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary, #e0e0e0);
    }
    
    .category-list-item-actions {
        display: flex;
        gap: 8px;
    }
    
    .category-list-item-actions button {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .btn-edit {
        background: var(--primary, #ff6b00);
        color: white;
    }
    
    .btn-edit:hover {
        background: #ff8533;
    }
    
    .btn-delete {
        background: #dc3545;
        color: white;
    }
    
    .btn-delete:hover {
        background: #c82333;
    }
    
    .category-list-empty {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary, #999);
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .empty-state-text {
        font-size: 16px;
        color: var(--text-secondary, #999);
        margin-bottom: 20px;
    }
    
    /* Kategorie-Karten im Dashboard */
    .category-card {
        background: var(--surface, #242424);
        border: 1px solid var(--border-color, #333);
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    
    .category-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(255, 107, 0, 0.2);
        border-color: var(--primary, #ff6b00);
    }
    
    .category-card-icon {
        font-size: 48px;
        margin-bottom: 10px;
    }
    
    .category-card-name {
        color: var(--text-primary, #e0e0e0);
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .category-card-count {
        color: var(--primary, #ff6b00);
        font-weight: bold;
        font-size: 24px;
        margin-bottom: 4px;
    }
    
    .category-card-value {
        color: var(--text-secondary, #999);
        font-size: 12px;
    }
    </style>
</head>
<body>

<!-- ================= HEADER ================= -->
<header class="app-header">
    <div class="header-left">
        <h1>üì¶ ef-sin Inventur <span class="version">v2.1.7</span></h1>
    </div>
    <div class="header-right">
        <button id="themeToggle" class="btn-icon" title="Dark Mode">
            <span id="themeIcon">üåô</span>
        </button>
        <button id="syncButton" class="btn-icon" title="Sync">üîÑ</button>
        <button id="menuButton" class="btn-icon" title="Men√º">‚ò∞</button>
    </div>
</header>

<!-- ================= MAIN TABS ================= -->
<nav class="main-tabs">
    <button class="main-tab active" data-tab="dashboard">üìä √úbersicht</button>
    <button class="main-tab" data-tab="inventory">üì¶ Bestand</button>
    <button class="main-tab" data-tab="scanner">üì∑ Scanner</button>
    <button class="main-tab" data-tab="statistics">üìà Statistik</button>
</nav>

<!-- ================= DASHBOARD TAB ================= -->
<div id="dashboard" class="tab-content active">
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="dashboard-card-icon">üì¶</div>
            <div class="dashboard-card-value" id="dashTotalItems">0</div>
            <div class="dashboard-card-label">Artikel</div>
        </div>
        
        <div class="dashboard-card warning">
            <div class="dashboard-card-icon">‚ö†Ô∏è</div>
            <div class="dashboard-card-value" id="dashLowStock">0</div>
            <div class="dashboard-card-label">Niedrig</div>
        </div>
        
        <div class="dashboard-card">
            <div class="dashboard-card-icon">üìÅ</div>
            <div class="dashboard-card-value" id="dashCategories">0</div>
            <div class="dashboard-card-label">Kategorien</div>
        </div>
        
        <div class="dashboard-card">
            <div class="dashboard-card-icon">üí∂</div>
            <div class="dashboard-card-value" id="dashTotalValue">0‚Ç¨</div>
            <div class="dashboard-card-label">Gesamtwert</div>
        </div>
    </div>
    
    <div class="stats-section">
        <h3 class="stats-title">Kategorien √úbersicht</h3>
        <div id="categoryCards" class="dashboard-grid"></div>
    </div>
    
    <div class="stats-section">
        <h3 class="stats-title">Letzte Aktivit√§ten</h3>
        <div id="recentActivity" class="activity-list"></div>
    </div>
</div>

<!-- ================= BESTAND TAB ================= -->
<div id="inventory" class="tab-content">
    <!-- Kategorie Tabs -->
    <nav class="category-tabs" id="categoryTabs"></nav>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        <button id="addNormalButton" class="btn-primary">
            <span class="btn-icon">+</span>
            <span class="btn-text">Artikel</span>
        </button>
        <button id="addQuickButton" class="btn-success">
            <span class="btn-icon">‚ö°</span>
            <span class="btn-text">Quick Add</span>
        </button>
    </div>
    
    <!-- Suche -->
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="üîç Suchen...">
    </div>
    
    <!-- Artikel Liste -->
    <main class="items-container" id="itemsContainer"></main>
</div>

<!-- ================= SCANNER TAB ================= -->
<div id="scanner" class="tab-content">
    <div class="empty-state">
        <div class="empty-state-icon">üì∑</div>
        <div class="empty-state-text">Scanner-Funktion</div>
        <p style="color: var(--text-secondary, #999);">Wird in der n√§chsten Version implementiert</p>
    </div>
</div>

<!-- ================= STATISTIK TAB ================= -->
<div id="statistics" class="tab-content">
    <div class="stats-section">
        <h3 class="stats-title">Artikel pro Kategorie</h3>
        <div id="categoryChart" class="category-chart"></div>
    </div>
    
    <div class="stats-section">
        <h3 class="stats-title">Wertverteilung</h3>
        <div id="valueDistribution" class="value-distribution"></div>
    </div>
    
    <div class="stats-section">
        <h3 class="stats-title">Bestands√ºbersicht</h3>
        <div id="stockOverview" class="value-distribution"></div>
    </div>
</div>

<!-- ================= LOADING ================= -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>Lade...</p>
</div>

<!-- ================= MODALS (wie vorher) ================= -->
<!-- Artikel Modal -->
<div class="modal" id="addModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Artikel</h2>
            <button class="btn-close" onclick="app.closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="itemCategory">Kategorie *</label>
                <select id="itemCategory" required></select>
            </div>
            <div class="form-group">
                <label for="itemName">Name *</label>
                <input type="text" id="itemName" required>
            </div>
            <div class="form-group">
                <label for="itemSKU">SKU</label>
                <input type="text" id="itemSKU">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="itemStock">Bestand *</label>
                    <input type="number" id="itemStock" required>
                </div>
                <div class="form-group">
                    <label for="itemUnit">Einheit</label>
                    <select id="itemUnit">
                        <option>St√ºck</option>
                        <option>Meter</option>
                        <option>Kilogramm</option>
                        <option>Liter</option>
                        <option>Paket</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="itemMin">Min</label>
                    <input type="number" id="itemMin">
                </div>
                <div class="form-group">
                    <label for="itemMax">Max</label>
                    <input type="number" id="itemMax">
                </div>
                <div class="form-group">
                    <label for="itemPrice">Preis (‚Ç¨)</label>
                    <input type="number" step="0.01" id="itemPrice">
                </div>
            </div>
            <div class="form-group">
                <label for="itemLocation">Standort</label>
                <input type="text" id="itemLocation">
            </div>
            <div class="form-group">
                <label for="itemPhoto">Foto</label>
                <input type="file" id="itemPhoto" accept="image/*">
                <div id="photoPreview" style="margin-top: 10px;"></div>
            </div>
            <div class="form-group">
                <label for="itemNotes">Notizen</label>
                <textarea id="itemNotes" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="app.closeModal()">Abbrechen</button>
            <button class="btn-primary" onclick="app.saveItem()">Speichern</button>
        </div>
    </div>
</div>

<!-- Quick Add Modal -->
<div class="modal" id="quickAddModal">
    <div class="modal-content quick-add">
        <div class="modal-header">
            <h2>‚ö° Schnelleingabe</h2>
            <button class="btn-close" onclick="quickAdd.close()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="quickCategory">Kategorie</label>
                <select id="quickCategory"></select>
            </div>
            <div class="form-group">
                <label for="quickSKU">SKU</label>
                <input type="text" id="quickSKU">
            </div>
            <div class="form-group">
                <label for="quickName">Name *</label>
                <input type="text" id="quickName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="quickStock">Anzahl *</label>
                    <input type="number" id="quickStock" required>
                </div>
                <div class="form-group">
                    <label for="quickPrice">Preis</label>
                    <input type="number" step="0.01" id="quickPrice">
                </div>
            </div>
            <div class="form-group">
                <label for="quickLocation">Standort</label>
                <input type="text" id="quickLocation">
            </div>
            <div class="form-group">
                <label for="quickPhoto">Foto</label>
                <input type="file" id="quickPhoto" accept="image/*">
                <div id="quickPhotoPreview" style="margin-top: 10px;"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="quickAdd.save()">Speichern</button>
        </div>
    </div>
</div>

<!-- Kategorie Edit Modal -->
<div class="modal" id="categoryEditModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="categoryModalTitle">Kategorie</h2>
            <button class="btn-close" onclick="closeCategoryEditModal()">√ó</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="catId">
            <div class="form-group">
                <label for="catName">Name *</label>
                <input type="text" id="catName" required>
            </div>
            <div class="form-group">
                <label>Icon *</label>
                <div class="icon-input-wrapper">
                    <div class="icon-preview" id="catIconPreview">üì¶</div>
                    <div class="icon-input-field">
                        <input type="text" id="catIcon" placeholder="üì¶" maxlength="4" value="üì¶">
                        <small>Emoji direkt eingeben oder ausw√§hlen</small>
                    </div>
                    <button type="button" class="icon-select-btn" id="openIconPickerBtn">
                        Icon ausw√§hlen
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCategoryEditModal()">Abbrechen</button>
            <button class="btn-primary" onclick="saveCategory()">Speichern</button>
        </div>
    </div>
</div>

<!-- Kategorie Management Modal -->
<div class="modal" id="categoryManagementModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2>üìÅ Kategorien verwalten</h2>
            <button class="btn-close" onclick="closeCategoryManagement()">√ó</button>
        </div>
        <div class="modal-body">
            <button class="btn-primary" style="width: 100%; margin-bottom: 20px;" onclick="openNewCategoryModal()">
                + Neue Kategorie
            </button>
            <div id="categoryListContainer"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCategoryManagement()">Schlie√üen</button>
        </div>
    </div>
</div>

<!-- GitHub Settings Modal -->
<div class="modal" id="githubSettingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚öôÔ∏è GitHub Einstellungen</h2>
            <button class="btn-close" onclick="closeGitHubSettings()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="ghToken">GitHub Token</label>
                <input type="password" id="ghToken" placeholder="ghp_...">
                <small>Personal Access Token mit repo-Rechten</small>
            </div>
            <div class="form-group">
                <label for="ghUsername">Username</label>
                <input type="text" id="ghUsername" placeholder="username">
            </div>
            <div class="form-group">
                <label for="ghRepo">Repository</label>
                <input type="text" id="ghRepo" placeholder="inventur-v2">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="ghAutoSync">
                    Auto-Sync aktivieren
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeGitHubSettings()">Abbrechen</button>
            <button class="btn-primary" onclick="saveGitHubSettings()">Speichern</button>
        </div>
    </div>
</div>

<!-- Icon Picker Modal -->
<div id="iconPickerModal" class="modal icon-picker-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üé® Icon ausw√§hlen</h2>
            <button class="btn-close" onclick="window.iconPicker && window.iconPicker.close()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="icon-picker-search">
                <input type="text" id="iconSearchInput" placeholder="üîç Icon suchen..." autocomplete="off">
            </div>
            <div class="icon-picker-tabs" id="iconPickerTabs"></div>
            <div class="icon-picker-grid" id="iconPickerGrid"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="window.iconPicker && window.iconPicker.close()">Abbrechen</button>
        </div>
    </div>
</div>

<!-- Men√º -->
<div class="menu-overlay" id="menuOverlay"></div>
<aside class="menu-sidebar" id="menuSidebar">
    <div class="menu-header">
        <h2>Men√º</h2>
        <button class="btn-close" id="menuCloseBtn">√ó</button>
    </div>
    <div class="menu-content">
        <button class="menu-item" id="menuCategoriesBtn">
            <span class="menu-icon">üìÅ</span>
            <span class="menu-text">Kategorien verwalten</span>
        </button>
        <button class="menu-item" id="menuExportBtn">
            <span class="menu-icon">üíæ</span>
            <span class="menu-text">Daten exportieren</span>
        </button>
        <button class="menu-item" id="menuImportBtn">
            <span class="menu-icon">üì•</span>
            <span class="menu-text">Daten importieren</span>
        </button>
        <button class="menu-item" id="menuGitHubBtn">
            <span class="menu-icon">‚öôÔ∏è</span>
            <span class="menu-text">GitHub Einstellungen</span>
        </button>
        <button class="menu-item" id="menuSyncBtn">
            <span class="menu-icon">üîÑ</span>
            <span class="menu-text">Jetzt synchronisieren</span>
        </button>
    </div>
</aside>

<!-- SCRIPTS -->
<script src="src/managers/CategoryManager.js"></script>
<script src="src/managers/ImageManager.js"></script>
<script src="src/managers/MultiFileGitHubSync.js"></script>
<script src="src/components/QuickAdd.js"></script>
<script src="src/components/IconPicker.js"></script>

<!-- KATEGORIE-SYSTEM & APP-INTEGRATION -->
<script>
console.log('üöÄ ef-sin Inventur v2.1.7 initializing...');

// =============================================================================
// KATEGORIE-VERWALTUNG (localStorage-basiert)
// =============================================================================

function loadCategories() {
    const stored = localStorage.getItem('categories');
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            console.error('Fehler beim Laden der Kategorien:', e);
        }
    }
    
    // Default-Kategorien
    const defaults = [
        { id: 'holz', name: 'Holz', icon: 'ü™µ' },
        { id: 'platten', name: 'Platten', icon: 'üìã' },
        { id: 'beschlaege', name: 'Beschl√§ge', icon: 'üî©' },
        { id: 'werkzeuge', name: 'Werkzeuge', icon: 'üî®' },
        { id: 'lacke', name: 'Lacke & √ñle', icon: 'üé®' },
        { id: 'schrauben', name: 'Schrauben', icon: '‚öôÔ∏è' },
        { id: 'sonstiges', name: 'Sonstiges', icon: 'üì¶' }
    ];
    saveCategories(defaults);
    return defaults;
}

function saveCategories(categories) {
    localStorage.setItem('categories', JSON.stringify(categories));
    console.log('‚úÖ Kategorien gespeichert:', categories.length);
    
    // App neu laden wenn vorhanden
    if (window.app && window.app.loadCategories) {
        window.app.loadCategories();
        window.app.renderItems();
    }
    
    // Dashboard aktualisieren
    updateDashboard();
    updateStatistics();
}

// Zu Kategorie-Ansicht wechseln
function switchToCategoryView(categoryName) {
    console.log('üîÑ Wechsle zu Kategorie:', categoryName);
    
    // Zum Bestand-Tab wechseln
    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    const inventoryTab = document.querySelector('[data-tab="inventory"]');
    if (inventoryTab) {
        inventoryTab.classList.add('active');
    }
    
    const inventoryContent = document.getElementById('inventory');
    if (inventoryContent) {
        inventoryContent.classList.add('active');
    }
    
    // Kategorie-Tab aktivieren
    setTimeout(() => {
        const categoryTabs = document.querySelectorAll('.category-tab');
        categoryTabs.forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.category === categoryName) {
                tab.classList.add('active');
            }
        });
        
        // App-Filter setzen
        if (window.app) {
            window.app.currentCategory = categoryName;
            window.app.renderItems();
        }
    }, 100);
}


function loadCategoryList() {
    const container = document.getElementById('categoryListContainer');
    const categories = loadCategories();
    
    if (categories.length === 0) {
        container.innerHTML = '<div class="category-list-empty">Keine Kategorien vorhanden</div>';
        return;
    }
    
    container.innerHTML = categories.map(cat => `
        <div class="category-list-item">
            <div class="category-list-item-info">
                <div class="category-list-item-icon">${cat.icon || 'üì¶'}</div>
                <div class="category-list-item-name">${cat.name}</div>
            </div>
            <div class="category-list-item-actions">
                <button class="btn-edit" onclick="editCategory('${cat.id}')">
                    ‚úèÔ∏è Bearbeiten
                </button>
                <button class="btn-delete" onclick="deleteCategory('${cat.id}')">
                    üóëÔ∏è L√∂schen
                </button>
            </div>
        </div>
    `).join('');
}

function editCategory(id) {
    const categories = loadCategories();
    const category = categories.find(c => c.id === id);
    
    if (!category) {
        alert('Kategorie nicht gefunden!');
        return;
    }
    
    document.getElementById('categoryModalTitle').textContent = 'Kategorie bearbeiten';
    document.getElementById('catId').value = id;
    document.getElementById('catName').value = category.name;
    document.getElementById('catIcon').value = category.icon || 'üì¶';
    document.getElementById('catIconPreview').textContent = category.icon || 'üì¶';
    document.getElementById('categoryEditModal').classList.add('active');
}

function deleteCategory(id) {
    const categories = loadCategories();
    const category = categories.find(c => c.id === id);
    
    if (!category) {
        alert('Kategorie nicht gefunden!');
        return;
    }
    
    if (!confirm(`Kategorie "${category.name}" wirklich l√∂schen?`)) {
        return;
    }
    
    const updated = categories.filter(c => c.id !== id);
    saveCategories(updated);
    loadCategoryList();
}

function showCategoryManagement() {
    document.getElementById('categoryManagementModal').classList.add('active');
    loadCategoryList();
}

function closeCategoryManagement() {
    document.getElementById('categoryManagementModal').classList.remove('active');
}

function openNewCategoryModal() {
    document.getElementById('categoryModalTitle').textContent = 'Neue Kategorie';
    document.getElementById('catId').value = '';
    document.getElementById('catName').value = '';
    document.getElementById('catIcon').value = 'üì¶';
    document.getElementById('catIconPreview').textContent = 'üì¶';
    document.getElementById('categoryEditModal').classList.add('active');
}

function closeCategoryEditModal() {
    document.getElementById('categoryEditModal').classList.remove('active');
}

function saveCategory() {
    const id = document.getElementById('catId').value;
    const name = document.getElementById('catName').value.trim();
    const icon = document.getElementById('catIcon').value.trim();
    
    if (!name) {
        alert('Bitte gebe einen Namen ein!');
        return;
    }
    
    const categories = loadCategories();
    
    if (id) {
        // Bestehende Kategorie bearbeiten
        const index = categories.findIndex(c => c.id === id);
        if (index !== -1) {
            categories[index].name = name;
            categories[index].icon = icon || 'üì¶';
        }
    } else {
        // Neue Kategorie erstellen
        const newId = 'cat_' + Date.now();
        categories.push({
            id: newId,
            name: name,
            icon: icon || 'üì¶'
        });
    }
    
    saveCategories(categories);
    closeCategoryEditModal();
    loadCategoryList();
    alert(`Kategorie "${name}" gespeichert!`);
}

// =============================================================================
// DASHBOARD & STATISTIK
// =============================================================================

function updateDashboard() {
    if (!window.app || !window.app.items) return;
    
    const items = window.app.items;
    const categories = loadCategories();
    
    // Gesamtzahl Artikel
    document.getElementById('dashTotalItems').textContent = items.length;
    
    // Niedrige Best√§nde
    const lowStock = items.filter(item => 
        item.min && parseInt(item.stock) <= parseInt(item.min)
    ).length;
    document.getElementById('dashLowStock').textContent = lowStock;
    
    // Anzahl Kategorien
    document.getElementById('dashCategories').textContent = categories.length;
    
    // Gesamtwert
    const totalValue = items.reduce((sum, item) => {
        const price = parseFloat(item.price) || 0;
        const stock = parseFloat(item.stock) || 0;
        return sum + (price * stock);
    }, 0);
    document.getElementById('dashTotalValue').textContent = totalValue.toFixed(2) + '‚Ç¨';
    
    // Letzte Aktivit√§ten (neueste 5 Artikel)
    const recentItems = items
        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
        .slice(0, 5);
    
    const activityContainer = document.getElementById('recentActivity');
    
    if (recentItems.length === 0) {
        activityContainer.innerHTML = '<div class="empty-state-text">Noch keine Artikel vorhanden</div>';
    } else {
        activityContainer.innerHTML = recentItems.map(item => `
            <div class="activity-item">
                <div class="activity-info">
                    <div class="activity-name">${item.name}</div>
                    <div class="activity-details">${item.category} ‚Ä¢ ${item.location || 'Kein Standort'}</div>
                </div>
                <div class="activity-stock">${item.stock} ${item.unit || 'Stk'}</div>
            </div>
        `).join('');
    }
    
    // Kategorie-Karten rendern
    const categoryCardsContainer = document.getElementById('categoryCards');
    
    if (categoryCardsContainer) {
        const categoryStats = categories.map(cat => {
            const catItems = items.filter(item => item.category === cat.name);
            const count = catItems.length;
            const value = catItems.reduce((sum, item) => {
                return sum + ((parseFloat(item.price) || 0) * (parseFloat(item.stock) || 0));
            }, 0);
            return { ...cat, count, value };
        });
        
        if (categoryStats.length === 0) {
            categoryCardsContainer.innerHTML = '<div class="empty-state-text">Keine Kategorien vorhanden</div>';
        } else {
            categoryCardsContainer.innerHTML = categoryStats.map(cat => `
                <div class="category-card" onclick="switchToCategoryView('${cat.name}')">
                    <div class="category-card-icon">${cat.icon}</div>
                    <div class="category-card-name">${cat.name}</div>
                    <div class="category-card-count">${cat.count}</div>
                    <div class="category-card-value">${cat.value.toFixed(2)}‚Ç¨</div>
                </div>
            `).join('');
        }
    }
}

function updateStatistics() {
    if (!window.app || !window.app.items) return;
    
    const items = window.app.items;
    const categories = loadCategories();
    
    // Artikel pro Kategorie
    const categoryStats = categories.map(cat => {
        const count = items.filter(item => item.category === cat.name).length;
        return { ...cat, count };
    }).filter(cat => cat.count > 0);
    
    const maxCount = Math.max(...categoryStats.map(c => c.count), 1);
    
    const chartContainer = document.getElementById('categoryChart');
    if (categoryStats.length === 0) {
        chartContainer.innerHTML = '<div class="empty-state-text">Keine Artikel vorhanden</div>';
    } else {
        chartContainer.innerHTML = categoryStats.map(cat => `
            <div class="chart-bar">
                <div class="chart-icon">${cat.icon}</div>
                <div class="chart-label">${cat.name}</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill" style="width: ${(cat.count / maxCount) * 100}%">
                        ${cat.count}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Wertverteilung
    const valueStats = categories.map(cat => {
        const catItems = items.filter(item => item.category === cat.name);
        const value = catItems.reduce((sum, item) => {
            return sum + ((parseFloat(item.price) || 0) * (parseFloat(item.stock) || 0));
        }, 0);
        return { ...cat, value };
    }).filter(cat => cat.value > 0);
    
    const valueContainer = document.getElementById('valueDistribution');
    if (valueStats.length === 0) {
        valueContainer.innerHTML = '<div class="empty-state-text">Keine Werte vorhanden</div>';
    } else {
        valueContainer.innerHTML = valueStats.map(cat => `
            <div class="value-item">
                <div class="value-item-name">${cat.icon} ${cat.name}</div>
                <div class="value-item-value">${cat.value.toFixed(2)}‚Ç¨</div>
            </div>
        `).join('');
    }
    
    // Bestands√ºbersicht
    const stockContainer = document.getElementById('stockOverview');
    const totalStock = items.length;
    const okStock = items.filter(item => !item.min || parseInt(item.stock) > parseInt(item.min)).length;
    const lowStockCount = items.filter(item => item.min && parseInt(item.stock) <= parseInt(item.min) && parseInt(item.stock) > 0).length;
    const emptyStock = items.filter(item => parseInt(item.stock) === 0).length;
    
    stockContainer.innerHTML = `
        <div class="value-item" style="border-color: #4caf50;">
            <div class="value-item-name">‚úÖ OK</div>
            <div class="value-item-value" style="color: #4caf50;">${okStock}</div>
        </div>
        <div class="value-item" style="border-color: #ff6b00;">
            <div class="value-item-name">‚ö†Ô∏è Niedrig</div>
            <div class="value-item-value" style="color: #ff6b00;">${lowStockCount}</div>
        </div>
        <div class="value-item" style="border-color: #dc3545;">
            <div class="value-item-name">‚ùå Leer</div>
            <div class="value-item-value" style="color: #dc3545;">${emptyStock}</div>
        </div>
        <div class="value-item">
            <div class="value-item-name">üì¶ Gesamt</div>
            <div class="value-item-value">${totalStock}</div>
        </div>
    `;
}

// =============================================================================
// GLOBALE FUNKTIONEN
// =============================================================================

function exportData() {
    if (window.app && window.app.exportData) {
        window.app.exportData();
    } else {
        alert('Export-Funktion wird geladen...');
    }
}

function importData() {
    if (window.app && window.app.importData) {
        window.app.importData();
    } else {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.categories) {
                            saveCategories(data.categories);
                            loadCategoryList();
                        }
                        if (data.items && window.app) {
                            window.app.items = data.items;
                            window.app.saveToIndexedDB();
                            window.app.renderItems();
                        }
                        alert('Daten importiert!');
                    } catch (err) {
                        alert('Fehler beim Importieren!');
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }
}

function showGitHubSettings() {
    document.getElementById('githubSettingsModal').classList.add('active');
    document.getElementById('ghToken').value = localStorage.getItem('github_token') || '';
    document.getElementById('ghUsername').value = localStorage.getItem('github_username') || '';
    document.getElementById('ghRepo').value = localStorage.getItem('github_repo') || '';
    document.getElementById('ghAutoSync').checked = localStorage.getItem('github_autosync') === 'true';
}

function closeGitHubSettings() {
    document.getElementById('githubSettingsModal').classList.remove('active');
}

function saveGitHubSettings() {
    const token = document.getElementById('ghToken').value;
    const username = document.getElementById('ghUsername').value;
    const repo = document.getElementById('ghRepo').value;
    const autoSync = document.getElementById('ghAutoSync').checked;
    
    localStorage.setItem('github_token', token);
    localStorage.setItem('github_username', username);
    localStorage.setItem('github_repo', repo);
    localStorage.setItem('github_autosync', autoSync);
    
    closeGitHubSettings();
    alert('GitHub Einstellungen gespeichert!');
}

function manualSync() {
    if (window.githubSync && window.githubSync.sync) {
        window.githubSync.sync();
    } else {
        alert('Sync wird noch initialisiert...');
    }
}

// =============================================================================
// DOM CONTENT LOADED
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM loaded');
    
    // Tab-Navigation
    const mainTabs = document.querySelectorAll('.main-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    mainTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // Tabs umschalten
            mainTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Content umschalten
            tabContents.forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            // Statistiken aktualisieren wenn Tab ge√∂ffnet wird
            if (tabName === 'statistics') {
                updateStatistics();
            }
        });
    });
    
    // Men√º Event-Handler
    const menuButton = document.getElementById('menuButton');
    const menuSidebar = document.getElementById('menuSidebar');
    const menuOverlay = document.getElementById('menuOverlay');
    const menuCloseBtn = document.getElementById('menuCloseBtn');
    
    function closeMenu() {
        if (menuSidebar) menuSidebar.classList.remove('active');
        if (menuOverlay) menuOverlay.classList.remove('active');
    }
    
    if (menuButton) {
        menuButton.addEventListener('click', function() {
            if (menuSidebar) menuSidebar.classList.add('active');
            if (menuOverlay) menuOverlay.classList.add('active');
        });
    }
    
    if (menuCloseBtn) menuCloseBtn.addEventListener('click', closeMenu);
    if (menuOverlay) menuOverlay.addEventListener('click', closeMenu);
    
    // Men√º-Items
    document.getElementById('menuCategoriesBtn').addEventListener('click', () => { showCategoryManagement(); closeMenu(); });
    document.getElementById('menuExportBtn').addEventListener('click', () => { exportData(); closeMenu(); });
    document.getElementById('menuImportBtn').addEventListener('click', () => { importData(); closeMenu(); });
    document.getElementById('menuGitHubBtn').addEventListener('click', () => { showGitHubSettings(); closeMenu(); });
    document.getElementById('menuSyncBtn').addEventListener('click', () => { manualSync(); closeMenu(); });
    
    // Dark Mode
    const html = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    
    if (themeToggle && themeIcon) {
        const savedTheme = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const initialTheme = savedTheme || (systemDark ? 'dark' : 'light');
        
        html.setAttribute('data-theme', initialTheme);
        themeIcon.textContent = initialTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        
        themeToggle.addEventListener('click', function() {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        });
    }
    
    // ‚≠ê BUTTON EVENT-LISTENER - KRITISCH!
    const addNormalButton = document.getElementById('addNormalButton');
    const addQuickButton = document.getElementById('addQuickButton');
    
    if (addNormalButton) {
        addNormalButton.addEventListener('click', function() {
            console.log('üîµ Artikel Button clicked');
            if (window.app && window.app.openModal) {
                window.app.openModal('itemModal');
            }
        });
    }
    
    if (addQuickButton) {
        addQuickButton.addEventListener('click', function() {
            console.log('üü¢ Quick Add Button clicked');
            if (window.app && window.app.openModal) {
                window.app.openModal('quickAddModal');
            }
        });
    }
    
    // Modal Close Buttons
    const modalCloseButtons = document.querySelectorAll('[onclick*="closeModal"]');
    modalCloseButtons.forEach(btn => {
        const modalId = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (window.app && window.app.closeModal) {
                window.app.closeModal(modalId);
            }
        });
    });
    
    // Icon Picker
    if (typeof IconPicker !== 'undefined') {
        window.iconPicker = new IconPicker();
        
        const catIconInput = document.getElementById('catIcon');
        const catIconPreview = document.getElementById('catIconPreview');
        const openPickerBtn = document.getElementById('openIconPickerBtn');
        
        if (catIconInput && catIconPreview) {
            catIconInput.addEventListener('input', function() {
                const icon = this.value.trim();
                if (icon) catIconPreview.textContent = icon;
            });
        }
        
        if (openPickerBtn) {
            openPickerBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const currentIcon = catIconInput.value || 'üì¶';
                window.iconPicker.open(currentIcon, function(selectedIcon) {
                    catIconInput.value = selectedIcon;
                    catIconPreview.textContent = selectedIcon;
                });
            });
        }
    }
    
    // Foto Upload Preview
    const itemPhoto = document.getElementById('itemPhoto');
    const photoPreview = document.getElementById('photoPreview');
    
    if (itemPhoto && photoPreview) {
        itemPhoto.addEventListener('change', function(e) {
            photoPreview.innerHTML = '';
            const file = e.target.files[0];
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '200px';
                    img.style.borderRadius = '8px';
                    photoPreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    const quickPhoto = document.getElementById('quickPhoto');
    const quickPhotoPreview = document.getElementById('quickPhotoPreview');
    
    if (quickPhoto && quickPhotoPreview) {
        quickPhoto.addEventListener('change', function(e) {
            quickPhotoPreview.innerHTML = '';
            const file = e.target.files[0];
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '200px';
                    img.style.borderRadius = '8px';
                    quickPhotoPreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    console.log('‚úÖ ef-sin Inventur v2.1.7 - Initialization complete!');
});
</script>

<!-- APP.JS LADEN -->
<script src="app.js"></script>

<!-- APP-INTEGRATION NACH LOAD -->
<script>
// Warte bis app.js geladen ist
window.addEventListener('load', function() {
    console.log('üîó Verbinde Kategorie-System mit App...');
    
    // Override app.loadCategories um localStorage zu nutzen
    if (window.app) {
        const originalLoadCategories = window.app.loadCategories.bind(window.app);
        
        window.app.loadCategories = function() {
            console.log('üìÅ Lade Kategorien aus localStorage...');
            const categories = loadCategories();
            
            // Konvertiere zu altem Format f√ºr Kompatibilit√§t
            window.app.categories = categories.map(c => c.name);
            
            // Render Category Tabs
            const tabsContainer = document.getElementById('categoryTabs');
            if (tabsContainer) {
                tabsContainer.innerHTML = `
                    <button class="category-tab active" data-category="Alle">Alle</button>
                    ${categories.map(cat => `
                        <button class="category-tab" data-category="${cat.name}">
                            ${cat.icon} ${cat.name}
                        </button>
                    `).join('')}
                `;
                
                // Event-Listener f√ºr Tabs
                tabsContainer.querySelectorAll('.category-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        tabsContainer.querySelectorAll('.category-tab').forEach(t => 
                            t.classList.remove('active')
                        );
                        this.classList.add('active');
                        window.app.currentCategory = this.dataset.category;
                        window.app.renderItems();
                    });
                });
            }
            
            // Update Dropdowns
            const categorySelect = document.getElementById('itemCategory');
            const quickCategorySelect = document.getElementById('quickCategory');
            
            if (categorySelect) {
                categorySelect.innerHTML = categories.map(cat => 
                    `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
                ).join('');
            }
            
            if (quickCategorySelect) {
                quickCategorySelect.innerHTML = categories.map(cat => 
                    `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
                ).join('');
            }
            
            console.log('‚úÖ Kategorien geladen:', categories.length);
        };
        
        // ‚≠ê KEINE OVERRIDES MEHR N√ñTIG!
        // app.js v2.1.6 ruft updateDashboard() und updateStatistics() selbst auf!
        
        // Initial laden
        window.app.loadCategories();
        
        // Dashboard initial aktualisieren
        setTimeout(() => {
            updateDashboard();
            updateStatistics();
        }, 500);
    }
});
</script>

</body>
</html>
